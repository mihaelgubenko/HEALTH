{% extends 'base.html' %}
{% load static %}

{% block title %}–ò–ò-—Å–µ–∫—Ä–µ—Ç–∞—Ä—å - –¶–µ–Ω—Ç—Ä –∑–¥–æ—Ä–æ–≤—å—è "–ù–æ–≤–∞—è –ñ–∏–∑–Ω—å"{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 600px;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .chat-messages {
        height: 500px;
        overflow-y: auto;
        padding: 20px;
        background-color: #f8f9fa;
    }
    
    .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 15px;
        max-width: 80%;
    }
    
    .user-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
    }
    
    .ai-message {
        background-color: white;
        color: #333;
        border: 1px solid #dee2e6;
    }
    
    .chat-input {
        height: 100px;
        border-top: 1px solid #dee2e6;
        padding: 15px;
        background-color: white;
    }
    
    .typing-indicator {
        display: none;
        color: #6c757d;
        font-style: italic;
    }
    
    .service-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 10px;
        margin: 5px 0;
        background-color: #f8f9fa;
    }
    
    .slot-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin: 10px 0;
    }
    
    .slot-btn {
        padding: 5px 10px;
        border: 1px solid #007bff;
        background-color: white;
        color: #007bff;
        border-radius: 15px;
        cursor: pointer;
        font-size: 12px;
    }
    
    .slot-btn:hover {
        background-color: #007bff;
        color: white;
    }
    
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ */
        .interactive-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥ */
        .service-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex: 1 1 calc(50% - 10px);
            min-width: 150px;
        }
        
        .service-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        /* –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ */
        .specialist-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex: 1 1 calc(33.33% - 10px);
            min-width: 120px;
            text-align: center;
        }
        
        .specialist-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
        }
        
        .specialist-btn strong {
            display: block;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .specialist-btn small {
            display: block;
            font-size: 11px;
            opacity: 0.9;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ —Å–ª–æ—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–∏ */
        .time-slot-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex: 0 1 auto;
            min-width: 80px;
        }
        
        .time-slot-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
        }
        
        /* –ö–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è */
        .confirm-btn {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .confirm-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .cancel-btn {
            background: linear-gradient(135deg, #f5576c 0%, #ff6b6b 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .cancel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
        .calendar-widget {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            max-width: 350px;
        }
    
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        font-weight: bold;
    }
    
    .calendar-nav-btn {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #007bff;
        padding: 5px 10px;
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }
    
    .calendar-day-header {
        text-align: center;
        font-size: 12px;
        color: #666;
        padding: 5px;
        font-weight: bold;
    }
    
    .calendar-day {
        text-align: center;
        padding: 10px 5px;
        cursor: pointer;
        border-radius: 5px;
        transition: all 0.2s;
        font-size: 14px;
    }
    
    .calendar-day:hover:not(.disabled):not(.empty) {
        background-color: #e3f2fd;
    }
    
    .calendar-day.disabled {
        color: #ccc;
        cursor: not-allowed;
    }
    
    .calendar-day.selected {
        background-color: #007bff;
        color: white;
        font-weight: bold;
    }
    
    /* –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ */
    .appointment-confirmation {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin: 15px 0;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .appointment-confirmation h4 {
        margin: 0 0 15px 0;
        font-size: 20px;
    }
    
    .appointment-detail {
        display: flex;
        align-items: center;
        margin: 10px 0;
        font-size: 16px;
    }
    
    .appointment-detail i {
        margin-right: 10px;
        width: 25px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-4">
                <i class="fas fa-robot text-primary me-2"></i>
                –ò–ò-—Å–µ–∫—Ä–µ—Ç–∞—Ä—å "–ù–æ–≤–∞—è –ñ–∏–∑–Ω—å"
            </h2>
            <p class="text-center text-muted mb-4">
                –ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –ø—Ä–∏—ë–º –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ!
            </p>
        </div>
    </div>
    
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai-message">
                        <strong>–ò–ò-—Å–µ–∫—Ä–µ—Ç–∞—Ä—å:</strong><br>
                        üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ø–æ–º–æ–≥—É –≤–∞–º –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏—ë–º –≤ —Ü–µ–Ω—Ç—Ä "–ù–æ–≤–∞—è –ñ–∏–∑–Ω—å".<br><br>
                        <strong>–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É:</strong>
                    </div>
                    <!-- –°—Ç–∞—Ä—Ç–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ —É—Å–ª—É–≥ -->
                    <div class="interactive-buttons" id="initialServiceButtons">
                        <!-- –ö–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>
                
                <div class="typing-indicator" id="typingIndicator">
                    –ò–ò-—Å–µ–∫—Ä–µ—Ç–∞—Ä—å –ø–µ—á–∞—Ç–∞–µ—Ç...
                </div>
                
                <div class="chat-input">
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageInput" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                               onkeypress="handleKeyPress(event)">
                        <button class="btn btn-primary" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">–ù–∞—à–∏ —É—Å–ª—É–≥–∏</h5>
                </div>
                <div class="card-body">
                    <div class="row" id="servicesList">
                        <!-- –£—Å–ª—É–≥–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ AJAX -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let sessionId = generateSessionId();
let currentAppointmentData = {};

function generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç
    addMessage(message, 'user');
    input.value = '';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
    showTypingIndicator();
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
    fetch('/api/chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            message: message,
            session_id: sessionId
        })
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        hideTypingIndicator();
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–û: data —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç reply, intent, entities
        // –ù–µ –Ω—É–∂–Ω–æ data.response!
        handleAIResponse(data);
    })
    .catch(error => {
        hideTypingIndicator();
        addMessage('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message, 'ai');
        console.error('Error:', error);
    });
}

function handleAIResponse(response) {
    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ response —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!response) {
        addMessage('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'ai');
        console.error('Response is undefined or null');
        return;
    }

    // –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—à–∏–±–∫—É —Å–µ—Ä–≤–µ—Ä–∞
    if (response.error) {
        addMessage(`–û—à–∏–±–∫–∞: ${response.error}`, 'ai');
        console.error('Server error:', response.error);
        return;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ò–ò (–ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ undefined)
    if (response.reply && response.reply !== 'undefined') {
        addMessage(response.reply, 'ai');
    } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç reply - —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
        console.warn('No reply in response:', response);
        addMessage('–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ –ø–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.', 'ai');
        return;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É—â–Ω–æ—Å—Ç–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞
    if (response.entities) {
        currentAppointmentData = {...currentAppointmentData, ...response.entities};
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥
    if (response.intent === 'collect_service') {
        showServiceButtons();
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
    if (response.intent === 'collect_specialist') {
        showSpecialistButtons();
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∫–æ–≥–¥–∞ AI —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–∞—Ç—É
    if (response.intent === 'collect_date' || response.intent === 'collect_day') {
        showCalendar();
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏
    if (response.intent === 'collect_time') {
        showTimeSlots();
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ –æ—Ç–≤–µ—Ç–µ)
    if (response.offer_slots && response.offer_slots.length > 0) {
        addSlotButtons(response.offer_slots);
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–ø–∏—Å–∏
    if (response.intent === 'time_collected' || response.intent === 'booking_completed') {
        showAppointmentConfirmation(response.entities || currentAppointmentData);
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    if (response.intent && (response.intent.includes('collect_') || response.intent === 'error')) {
        if (response.reply && (response.reply.includes('–ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?') || 
                              response.reply.includes('–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞') || 
                              response.reply.includes('–∏–º—è'))) {
            showNavigationButtons(response.intent);
        }
    }
}

function addMessage(text, sender) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    if (sender === 'ai') {
        messageDiv.innerHTML = `<strong>–ò–ò-—Å–µ–∫—Ä–µ—Ç–∞—Ä—å:</strong><br>${text}`;
    } else {
        messageDiv.innerHTML = `<strong>–í—ã:</strong><br>${text}`;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function addSlotButtons(slots) {
    const messagesContainer = document.getElementById('chatMessages');
    const slotDiv = document.createElement('div');
    slotDiv.className = 'slot-buttons';
    
    slots.forEach(slot => {
        const btn = document.createElement('button');
        btn.className = 'slot-btn';
        btn.textContent = slot;
        btn.onclick = () => {
            document.getElementById('messageInput').value = slot;
            sendMessage();
        };
        slotDiv.appendChild(btn);
    });
    
    messagesContainer.appendChild(slotDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function addServiceInfo(service) {
    const messagesContainer = document.getElementById('chatMessages');
    const serviceDiv = document.createElement('div');
    serviceDiv.className = 'service-card';
    serviceDiv.innerHTML = `<strong>–£—Å–ª—É–≥–∞:</strong> ${service}`;
    messagesContainer.appendChild(serviceDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function addSpecialistInfo(specialist) {
    const messagesContainer = document.getElementById('chatMessages');
    const specialistDiv = document.createElement('div');
    specialistDiv.className = 'service-card';
    specialistDiv.innerHTML = `<strong>–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç:</strong> ${specialist}`;
    messagesContainer.appendChild(specialistDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTypingIndicator() {
    document.getElementById('typingIndicator').style.display = 'block';
}

function hideTypingIndicator() {
    document.getElementById('typingIndicator').style.display = 'none';
}

function createAppointment() {
    fetch('/api/appointment/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            session_id: sessionId,
            ...currentAppointmentData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addMessage('‚úÖ –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.', 'ai');
            currentAppointmentData = {};
        } else {
            addMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏: ' + data.error, 'ai');
        }
    })
    .catch(error => {
        addMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏.', 'ai');
        console.error('Error:', error);
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Å–ª—É–≥–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ —É—Å–ª—É–≥ —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    const initialButtons = document.getElementById('initialServiceButtons');
    if (initialButtons) {
        showServiceButtons(initialButtons);
    }
    
    fetch('/api/services/')
        .then(response => response.json())
        .then(data => {
            if (data.services) {
                const servicesContainer = document.getElementById('servicesList');
                if (servicesContainer) {
                    data.services.forEach(service => {
                        const serviceDiv = document.createElement('div');
                        serviceDiv.className = 'col-md-6 mb-3';
                        serviceDiv.innerHTML = `
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">${service.name}</h6>
                                    <p class="card-text small">${service.description}</p>
                                    <p class="card-text"><strong>${service.price}‚Ç™</strong></p>
                                </div>
                            </div>
                        `;
                        servicesContainer.appendChild(serviceDiv);
                    });
                }
            }
        })
        .catch(error => console.error('Error loading services:', error));
});

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥
function showServiceButtons(targetElement = null) {
    const messagesContainer = document.getElementById('chatMessages');
    const buttonsDiv = targetElement || document.createElement('div');
    
    if (!targetElement) {
        buttonsDiv.className = 'interactive-buttons';
    }
    
    // –í–°–ï —É—Å–ª—É–≥–∏ –∏–∑ –ë–î
    const services = [
        {name: '–õ–µ—á–µ–±–Ω—ã–π –º–∞—Å—Å–∞–∂ –¥–ª—è –∂–µ–Ω—â–∏–Ω (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —à–≤–µ–¥—Å–∫–∏–π)', emoji: 'üíÜ‚Äç‚ôÄÔ∏è', description: '–ú–∞—Å—Å–∞–∂ –¥–ª—è –∂–µ–Ω—â–∏–Ω'},
        {name: '–õ–µ—á–µ–±–Ω—ã–π –º–∞—Å—Å–∞–∂ –¥–ª—è –º—É–∂—á–∏–Ω (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —à–≤–µ–¥—Å–∫–∏–π)', emoji: 'üíÜ‚Äç‚ôÇÔ∏è', description: '–ú–∞—Å—Å–∞–∂ –¥–ª—è –º—É–∂—á–∏–Ω'},
        {name: '–ú–∞—Å—Å–∞–∂ –¥–µ—Ç—Å–∫–∏–π', emoji: 'üë∂', description: '–î–µ—Ç—Å–∫–∏–π –º–∞—Å—Å–∞–∂'},
        {name: '–ú–∞—Å—Å–∞–∂ –≥—Ä—É–¥–Ω—ã–º –¥–µ—Ç—è–º', emoji: 'üçº', description: '–ú–∞—Å—Å–∞–∂ –≥—Ä—É–¥–Ω–∏—á–∫–∞–º'},
        {name: '–ú–∞—Å—Å–∞–∂ –±–µ—Ä–µ–º–µ–Ω–Ω—ã–º (–æ—Ç 5 –º–µ—Å—è—Ü–µ–≤)', emoji: 'ü§∞', description: '–ú–∞—Å—Å–∞–∂ –±–µ—Ä–µ–º–µ–Ω–Ω—ã–º'},
        {name: '–ú–∞—Å—Å–∞–∂ –ø–æ—Å–ª–µ —Ä–æ–¥–æ–≤', emoji: 'üë©‚Äçüçº', description: '–ú–∞—Å—Å–∞–∂ –ø–æ—Å–ª–µ —Ä–æ–¥–æ–≤'},
        {name: '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –æ—Å—Ç–µ–æ–ø–∞—Ç–∞', emoji: 'ü¶¥', description: '–û—Å—Ç–µ–æ–ø–∞—Ç'},
        {name: '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Ä–µ–∞–±–∏–ª–∏—Ç–æ–ª–æ–≥–∞', emoji: 'üèÉ', description: '–†–µ–∞–±–∏–ª–∏—Ç–æ–ª–æ–≥'},
        {name: '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥–∞', emoji: 'ü•ó', description: '–ù—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥'},
        {name: '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—Ä–≥–∞–Ω–∏–∑–º–∞ –±–∏–æ—Ä–µ–∑–æ–Ω–∞–Ω—Å–Ω—ã–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º (–±–∞–∑–æ–≤–∞—è)', emoji: 'üîç', description: '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –±–∞–∑–æ–≤–∞—è'},
        {name: '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—Ä–≥–∞–Ω–∏–∑–º–∞ –±–∏–æ—Ä–µ–∑–æ–Ω–∞–Ω—Å–Ω—ã–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è)', emoji: 'üî¨', description: '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è'},
        {name: '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—Ä–≥–∞–Ω–∏–∑–º–∞ –±–∏–æ—Ä–µ–∑–æ–Ω–∞–Ω—Å–Ω—ã–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º (VIP)', emoji: '‚≠ê', description: '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ VIP'},
        {name: '–ö–∏–Ω–µ–∑–∏–æ—Ç–µ–π–ø–∏—Ä–æ–≤–∞–Ω–∏–µ', emoji: 'ü©π', description: '–ö–∏–Ω–µ–∑–∏–æ—Ç–µ–π–ø–∏—Ä–æ–≤–∞–Ω–∏–µ'},
        {name: '–ü–æ–¥–±–æ—Ä –∫–æ–º–ø–ª–µ–∫—Å–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π', emoji: 'üèãÔ∏è', description: '–ö–æ–º–ø–ª–µ–∫—Å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π'}
    ];
    
    services.forEach(service => {
        const btn = document.createElement('button');
        btn.className = 'service-btn';
        btn.innerHTML = `<div>${service.emoji}</div><div><strong>${service.description}</strong></div>`;
        btn.onclick = () => selectOption(service.name, buttonsDiv);
        buttonsDiv.appendChild(btn);
    });
    
    if (!targetElement) {
        messagesContainer.appendChild(buttonsDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
function showSpecialistButtons() {
    const messagesContainer = document.getElementById('chatMessages');
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'interactive-buttons';
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ —Å –∏—Ö —É—Å–ª—É–≥–∞–º–∏
    const allSpecialists = [
        {
            name: '–ê–≤—Ä–∞–∞–º', 
            specialty: '–ú–∞—Å—Å–∞–∂–∏—Å—Ç', 
            emoji: 'üë®‚Äç‚öïÔ∏è',
            services: ['–º–∞—Å—Å–∞–∂', '–ª–µ—á–µ–±–Ω—ã–π –º–∞—Å—Å–∞–∂']
        },
        {
            name: '–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞', 
            specialty: '–û—Å—Ç–µ–æ–ø–∞—Ç/–†–µ–∞–±–∏–ª–∏—Ç–æ–ª–æ–≥/–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞', 
            emoji: 'üë©‚Äç‚öïÔ∏è',
            services: ['–æ—Å—Ç–µ–æ–ø–∞—Ç', '—Ä–µ–∞–±–∏–ª–∏—Ç–æ–ª–æ–≥', '–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞', '–∫–∏–Ω–µ–∑–∏–æ', '—É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è']
        },
        {
            name: '–†–∏–º–º–∞', 
            specialty: '–ù—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥', 
            emoji: 'üë©‚Äç‚öïÔ∏è',
            services: ['–Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥', '–ø–∏—Ç–∞–Ω–∏–µ']
        }
    ];
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —É—Å–ª—É–≥–µ
    let specialists = allSpecialists;
    if (currentAppointmentData.service) {
        const serviceLower = currentAppointmentData.service.toLowerCase();
        specialists = allSpecialists.filter(s => 
            s.services.some(service => serviceLower.includes(service))
        );
    }
    
    // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º
    if (specialists.length === 1) {
        selectOption(specialists[0].name, null);
        return;
    }
    
    specialists.forEach(specialist => {
        const btn = document.createElement('button');
        btn.className = 'specialist-btn';
        btn.innerHTML = `<div>${specialist.emoji}</div><strong>${specialist.name}</strong><br><small>${specialist.specialty}</small>`;
        btn.onclick = () => selectOption(specialist.name, buttonsDiv);
        buttonsDiv.appendChild(btn);
    });
    
    messagesContainer.appendChild(buttonsDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –æ–ø—Ü–∏–∏
function selectOption(value, buttonsDiv) {
    // –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ —á—Ç–æ–±—ã –Ω–µ–ª—å–∑—è –±—ã–ª–æ –∫–ª–∏–∫–Ω—É—Ç—å –¥–≤–∞–∂–¥—ã
    if (buttonsDiv) {
        const buttons = buttonsDiv.querySelectorAll('button');
        buttons.forEach(btn => {
            btn.disabled = true;
            btn.style.opacity = '0.5';
        });
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addMessage(value, 'user');
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ AI
    fetch('/api/chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: value,
            session_id: sessionId
        })
    })
    .then(response => {
        // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // –ò–°–ü–†–ê–í–õ–ï–ù–û: –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        console.log('AI Response:', data);
        handleAIResponse(data);
    })
    .catch(error => {
        addMessage('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message, 'ai');
        console.error('Error:', error);
    });
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
function showCalendar() {
    const messagesContainer = document.getElementById('chatMessages');
    const calendarWidget = document.createElement('div');
    calendarWidget.className = 'calendar-widget';
    
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                        '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
    const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
    
    let calendarHTML = `
        <div class="calendar-header">
            <span>${monthNames[currentMonth]} ${currentYear}</span>
        </div>
        <div class="calendar-grid">
    `;
    
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
    dayNames.forEach(day => {
        calendarHTML += `<div class="calendar-day-header">${day}</div>`;
    });
    
    // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    const startingDayOfWeek = (firstDay.getDay() + 6) % 7; // –ü–Ω=0, –í—Å=6
    
    // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–æ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è
    for (let i = 0; i < startingDayOfWeek; i++) {
        calendarHTML += '<div class="calendar-day empty"></div>';
    }
    
    // –î–Ω–∏ –º–µ—Å—è—Ü–∞
    for (let day = 1; day <= lastDay.getDate(); day++) {
        const date = new Date(currentYear, currentMonth, day);
        const isToday = date.toDateString() === today.toDateString();
        const isPast = date < today && !isToday;
        const isWeekend = date.getDay() === 0 || date.getDay() === 6; // 0=–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 6=–°—É–±–±–æ—Ç–∞
        
        let dayClass = 'calendar-day';
        if (isToday) dayClass += ' today';
        if (isPast || isWeekend) dayClass += ' disabled'; // –ò–°–ü–†–ê–í–õ–ï–ù–û: –í—ã—Ö–æ–¥–Ω—ã–µ —Ç–æ–∂–µ disabled
        
        const dateStr = date.toISOString().split('T')[0];
        
        calendarHTML += `
            <div class="${dayClass}"
                 ${!isPast && !isWeekend ? `onclick="selectDate('${dateStr}')"` : ''}>
                ${day}
            </div>
        `;
    }
    
    calendarHTML += '</div>';
    calendarWidget.innerHTML = calendarHTML;
    messagesContainer.appendChild(calendarWidget);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã
function selectDate(dateStr) {
    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–Ω—è
    // –í–∞–ª–∏–¥–∞—Ç–æ—Ä —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
    const messageText = dateStr;
    
    // –£–¥–∞–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
    const calendar = document.querySelector('.calendar-widget');
    if (calendar) {
        calendar.remove();
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
    selectOption(messageText, null);
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏
function showTimeSlots() {
    const messagesContainer = document.getElementById('chatMessages');
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'interactive-buttons';
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ —Å 9:00 –¥–æ 18:00
    const timeSlots = [];
    for (let hour = 9; hour < 19; hour++) {
        for (let minute of ['00', '30']) {
            timeSlots.push(`${hour}:${minute}`);
        }
    }
    
    timeSlots.forEach(timeSlot => {
        const btn = document.createElement('button');
        btn.className = 'time-slot-btn';
        btn.innerHTML = `<i class="far fa-clock"></i> ${timeSlot}`;
        btn.onclick = () => selectOption(timeSlot, buttonsDiv);
        buttonsDiv.appendChild(btn);
    });
    
    messagesContainer.appendChild(buttonsDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏
function showAppointmentConfirmation(data) {
    const messagesContainer = document.getElementById('chatMessages');
    const confirmationDiv = document.createElement('div');
    confirmationDiv.className = 'appointment-confirmation';
    
    confirmationDiv.innerHTML = `
        <div class="appointment-success-icon">‚úÖ</div>
        <h4>–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!</h4>
        <div class="appointment-detail">
            <i class="fas fa-user"></i>
            <span><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${data.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
        </div>
        <div class="appointment-detail">
            <i class="fas fa-phone"></i>
            <span><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${data.phone || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
        </div>
        <div class="appointment-detail">
            <i class="fas fa-stethoscope"></i>
            <span><strong>–£—Å–ª—É–≥–∞:</strong> ${data.service || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
        </div>
        <div class="appointment-detail">
            <i class="fas fa-user-md"></i>
            <span><strong>–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç:</strong> ${data.specialist || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
        </div>
        <div class="appointment-detail">
            <i class="fas fa-calendar"></i>
            <span><strong>–î–∞—Ç–∞:</strong> ${data.date || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
        </div>
        <div class="appointment-detail">
            <i class="fas fa-clock"></i>
            <span><strong>–í—Ä–µ–º—è:</strong> ${data.time || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
        </div>
        <hr style="border-color: rgba(255,255,255,0.3); margin: 15px 0;">
        <p style="margin: 0; font-size: 14px; opacity: 0.9;">
            <i class="fas fa-info-circle"></i>
            –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º –≤–∞–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ –¥–µ–Ω—å –¥–æ –ø—Ä–∏–µ–º–∞
        </p>
    `;
    
    messagesContainer.appendChild(confirmationDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showNavigationButtons(intent) {
    const messagesContainer = document.getElementById('chatMessages');
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'interactive-buttons navigation-buttons';
    buttonsDiv.style.marginTop = '15px';
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–∫–∞–∑–∞—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const buttons = [];
    
    if (intent === 'collect_phone' || intent.includes('phone')) {
        buttons.push({text: 'üìû –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω', action: 'fix_phone'});
        buttons.push({text: 'üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ', action: 'restart'});
    } else if (intent === 'collect_name' || intent.includes('name')) {
        buttons.push({text: 'üë§ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏–º—è', action: 'fix_name'});
        buttons.push({text: 'üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ', action: 'restart'});
    } else if (intent === 'collect_time' || intent.includes('time')) {
        buttons.push({text: '‚è∞ –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è', action: 'fix_time'});
        buttons.push({text: 'üìÖ –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É', action: 'fix_date'});
        buttons.push({text: 'üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ', action: 'restart'});
    } else {
        // –û–±—â–∏–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ª—é–±—ã—Ö –æ—à–∏–±–æ–∫
        buttons.push({text: 'üìû –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω', action: 'fix_phone'});
        buttons.push({text: 'üë§ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏–º—è', action: 'fix_name'});
        buttons.push({text: 'üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ', action: 'restart'});
    }
    
    buttons.forEach(buttonInfo => {
        const btn = document.createElement('button');
        btn.className = 'nav-btn';
        btn.innerHTML = buttonInfo.text;
        btn.style.cssText = `
            background: linear-gradient(135deg, #F39C12 0%, #E67E22 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        `;
        
        btn.onmouseover = () => {
            btn.style.transform = 'translateY(-2px)';
            btn.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
        };
        
        btn.onmouseout = () => {
            btn.style.transform = 'translateY(0)';
            btn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
        };
        
        btn.onclick = () => handleNavigationAction(buttonInfo.action, buttonsDiv);
        buttonsDiv.appendChild(btn);
    });
    
    messagesContainer.appendChild(buttonsDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function handleNavigationAction(action, buttonsDiv) {
    // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
    const buttons = buttonsDiv.querySelectorAll('button');
    buttons.forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.5';
    });
    
    let message = '';
    
    switch(action) {
        case 'fix_phone':
            message = '–•–æ—á—É –∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞';
            break;
        case 'fix_name':
            message = '–•–æ—á—É –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∏–º—è';
            break;
        case 'fix_time':
            message = '–•–æ—á—É –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è';
            break;
        case 'fix_date':
            message = '–•–æ—á—É –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É';
            break;
        case 'restart':
            message = '–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ';
            // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
            currentAppointmentData = {};
            break;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addMessage(message, 'user');
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ AI
    fetch('/api/chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message,
            session_id: sessionId
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Navigation Response:', data);
        handleAIResponse(data);
    })
    .catch(error => {
        addMessage('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + error.message, 'ai');
        console.error('Error:', error);
    });
}
</script>
{% endblock %}
