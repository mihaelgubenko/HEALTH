#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Family Health Center Bot..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ DATABASE_URL
if [ -z "$DATABASE_URL" ]; then
    echo "‚ùå –û–®–ò–ë–ö–ê: DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!"
    exit 1
fi

echo "‚úÖ DATABASE_URL –Ω–∞–π–¥–µ–Ω–∞: ${DATABASE_URL:0:20}..."

# –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
echo "üìä –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
python manage.py migrate --no-input --verbosity=2

if [ $? -eq 0 ]; then
    echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –û–®–ò–ë–ö–ê –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π!"
    exit 1
fi

# –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
echo "üìã –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö..."
python manage.py load_initial_data

if [ $? -eq 0 ]; then
    echo "‚úÖ –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"
fi

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Å–æ–∑–¥–∞–Ω–∏–µ/—Å–±—Ä–æ—Å admin –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (—á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è)
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ AUTO_CREATE_ADMIN=true –∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ADMIN_PASSWORD –≤ Railway ‚Üí Variables
if [ "${AUTO_CREATE_ADMIN:-false}" = "true" ]; then
    echo "üë§ –°–æ–∑–¥–∞–Ω–∏–µ/—Å–±—Ä–æ—Å admin –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."

    if [ -z "$ADMIN_PASSWORD" ]; then
        echo "üîê ADMIN_PASSWORD –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É—é –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å..."
        ADMIN_PASSWORD=$(python - <<'PY'
import secrets, string
alphabet = string.ascii_letters + string.digits + "!@#$%^&*()-_=+"
print(''.join(secrets.choice(alphabet) for _ in range(20)))
PY
)
        echo "‚ÑπÔ∏è –í–†–ï–ú–ï–ù–ù–´–ô –ü–ê–†–û–õ–¨ –î–õ–Ø admin: ${ADMIN_PASSWORD}"
    fi

    python manage.py reset_admin_password --password "$ADMIN_PASSWORD"
fi

# –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
echo "üìÅ –°–±–æ—Ä —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
python manage.py collectstatic --noinput

if [ $? -eq 0 ]; then
    echo "‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã —Å–æ–±—Ä–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤"
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "üåê –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞..."
exec gunicorn smart_secretary.wsgi:application --bind 0.0.0.0:$PORT